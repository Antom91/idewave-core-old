from io import BytesIO
from struct import pack

from World.WorldPacket.Constants.WorldOpCode import WorldOpCode
from World.Object.Unit.Spell.Constants.SpellCastFlags import SpellCastFlags
from Server.Connection.Connection import Connection
from Utils.Timer import Timer
from Typings.Abstract.AbstractHandler import AbstractHandler


class SpellResult(AbstractHandler):

    def __init__(self, **kwargs):
        self.data = kwargs.pop('data', bytes())
        self.connection: Connection = kwargs.pop('connection')

    async def process(self) -> tuple:
        buf = BytesIO(self.data)
        player = self.connection.player

        cast_flags = (
            SpellCastFlags.CAST_FLAG_UNKNOWN2.value |
            SpellCastFlags.CAST_FLAG_PERSISTENT_AA.value
        )

        spell_id = int.from_bytes(buf.read(4), 'little')

        response = bytes()
        response += player.packed_guid
        response += player.packed_guid
        response += pack(
            '<IHI',
            spell_id,
            cast_flags,
            Timer.get_ms_time(),
        )

        response += player.packed_guid

        return WorldOpCode.SMSG_SPELL_GO, [response]

    # async def process(self) -> tuple:
    #     response = b'\x01\x00\x00\x00\x00\x00\xff\x01\x00\x00\x00\x00\x00\x00\x002\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x01@\x00\x00\x00\x00\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00@\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00dP\x00\x00\x1f\x00\x00\x00F\x00\x00\x00\x00\x00\x02\x00\x00 \x00\x00'
    #     return WorldOpCode.SMSG_UPDATE_OBJECT, [response]
